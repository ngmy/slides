<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>reveal.js - Markdown Demo</title>
    <link rel="stylesheet" href="../../reveal.js/css/reveal.css">
    <link rel="stylesheet" href="../../reveal.js/css/theme/beige.css" id="theme">
    <link rel="stylesheet" href="../../reveal.js/lib/css/zenburn.css">
    <style type="text/css">
      .reveal h1,
      .reveal h2,
      .reveal h3,
      .reveal h4,
      .reveal h5,
      .reveal h6 {
        font-family: 'Lucida Grande', 'Hiragino Kaku Gothic ProN', 'ヒラギノ角ゴ ProN W3', Meiryo, メイリオ, sans-serif !important;
      }

      code {
        font-family: Consolas, 'Courier New', Courier, Monaco, monospace !important;
      }

      h2 {
        text-transform: none !important;
      }

      img.skillset-logo {
        width: 20%;
        height: 20%;
      }

      img.recent-business {
        float: left;
        width: 20%;
      }

      .content-right {
        margin-left: 52%;
      }

      cite {
        font-style: italic;
      }

      .white {
        color: #ffffff !important;
      }

      .green {
        color: #32B490 !important;
      }

      .red {
        color: #D45856 !important;
      }

      .inline {
        display: inline;
      }

      .underline {
        text-decoration: underline !important;
      }
    </style>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">

        <section data-markdown data-separator="^\n---\n$" data-vertical="^\n--\n$" data-element-attributes="{_\s*?([^}]+?)}">
          <script type="text/template">
            ## デプロイ改善物語

            2014.12.19

            ---

            ## 自己紹介

            * 永宮　悠大（Yuta Nagamiya）

            * 2008年度入社

            --

            ## スキルセット

            ![](img/php-logo.png) <!-- {_class="skillset-logo"} -->
            ![](img/codeigniter-logo.jpg) <!-- {_class="skillset-logo"} -->
            ![](img/laravel-logo.jpg) <!-- {_class="skillset-logo"} -->
            ![](img/mysql-logo.png) <!-- {_class="skillset-logo"} -->
            ![](img/memcached-logo.png) <!-- {_class="skillset-logo"} -->
            ![](img/apache-logo.png) <!-- {_class="skillset-logo"} -->
            ![](img/css3-html5-jquery-bootstrap-logo.png) <!-- {_class="skillset-logo"} -->
            ![](img/lpi-logo.jpg) <!-- {_class="skillset-logo"} -->

            --

            ## 最近の仕事

            ![](img/dmenunews.png) <!-- {_class="recent-business"} -->

            * dメニューニュース <!-- {_class="content-right"} -->

              * http://topics.smt.docomo.ne.jp/ <!-- {_class="content-right"} -->

            * 2012年12月リリース

            * 2014年11月リニューアル <!-- {_class="content-right"} -->

            ---

            ## デプロイ作業を改善する話

            --

            ## デプロイとは

            > ソフトウェアデプロイメント（英: Software deployment）とは、ソフトウェアシステムを利用可能にする活動全般を指す用語である。デプロイメント（Deployment）とは「展開、配備、配置」などの意。

            Wikipedia

            ---

            ## svn co

            --

            ## svn coによるデプロイ

            ```
            $ svn co https://repository.com/svn/site.com/trunk /var/www/site.com
            ```

            --

            ![](img/02.jpg)

            ## そんなわけない <!-- {_class="fragment" data-fragment-index="1"} -->

            --

            ## サーバの台数の増加

            * Webサーバが21台に

            * 1台1台デプロイしてたら日が暮れてしまう

            --

            ## 結果、こうなった

            ![](img/03.jpg)

            --

            ### <p class="green inline">複数のデプロイ先サーバ</P>にコマンド1発できるツールがどこかにないものか

            --

            ## ある

            ![](img/04.jpg)

            ---

            <!-- .slide: data-background="#32B490" -->

            ## pdsh <!-- {_class="white"} -->

            Parallel Distributed Shell <!-- {_class="white"} -->

            [https://code.google.com/p/pdsh/](https://code.google.com/p/pdsh/) <!-- {_class="white underline"} -->

            --

            ## pdshとは

            * SSHの並列実行ツール
            * リモートで複数のサーバに対してコマンドを実行できる

            --

            ## pdshによるデプロイ

            ```
            $ pdsh -g web "svn co https://repository.com/svn/site.com/trunk /var/www/site.com"
            ```

            --

            ![](img/02.jpg)

            ## そんなわけない <!-- {_class="fragment" data-fragment-index="1"} -->

            --

            ## アプリ構成の複雑化

            * ページキャッシュの利用

            * 別リポジトリで管理された共通部品の利用

            * Composerによるパッケージのインストール

            --

            ## これが

            ```
            $ pdsh -g web "svn co https://repository.com/svn/site.com/trunk /var/www/site.com"
            ```

            --

            ## こうなった

            ```
            $ pdsh -g web "svn co https://repository.com/svn/site.com/trunk /var/www/site.com"
            ```

            ```
            $ pdsh -g web "chmod o+w /var/www/site.com/application/logs"
            ```

            ```
            $ pdsh -g web "chmod o+w /var/www/site.com/application/cache"
            ```

            ```
            $ pdsh -g web "svn co https://repository.com/svn/base/trunk /var/www/site.com/base"
            ```

            ```
            $ pdsh -g web "cd /var/www/site.com; composer install"
            ```

            --

            ## 結果、こうなった

            ![](img/03.jpg)

            --

            #### 複雑なデプロイ手順を<br><p class="green inline">コマンド1つで実行</p>できる<br>ツールがどこかにないものか

            --

            ## ある

            ![](img/04.jpg)

            --

            ## Shell script <!-- {_class="red"} -->

            ![](img/01.jpg) <!-- {_class="fragment" data-fragment-index="1"} -->

            --

            ## <p class="red inline">Shell script</p>の問題点

            * 記述が煩雑すぎる

            * ちょっと複雑なことをしようとすると<br>誰も読めない複雑なスクリプトができあがる

            --

            #### 複雑なデプロイ手順を<br><p class="green inline">コマンド1つで実行</p>できて<br><p class="green inline">メンテナンスしやすい簡潔な記述</p>ができる<br>ツールがどこかにないものか

            --

            ## ある

            ![](img/04.jpg)

            ---

            <!-- .slide: data-background="#32B490" -->

            ## Deployer <!-- {_class="white"} -->

            Deployment Tool for PHP <!-- {_class="white"} -->

            [http://deployer.in/](http://deployer.in/) <!-- {_class="white underline"} -->

            --

            ## Deployerとは

            * PHP製のデプロイツール

            * タスクをPHPで記述することができる

            --

            <!-- .slide: data-transition="none" -->

            ## Deployerによるデプロイ

            ![](img/deployer_deploy_01.JPG)

            --

            <!-- .slide: data-transition="none" -->

            ## Deployerによるデプロイ

            ![](img/deployer_deploy_02.JPG)

            --

            <!-- .slide: data-transition="none" -->

            ## Deployerによるデプロイ

            ![](img/deployer_deploy_03.JPG)

            --

            <!-- .slide: data-transition="none" -->

            ## Deployerによるデプロイ

            ![](img/deployer_deploy_04.JPG)

            --

            <!-- .slide: data-transition="none" -->

            ## Deployerによるデプロイ

            ![](img/deployer_deploy_05.JPG)

            --

            <!-- .slide: data-transition="none" -->

            ## Deployerによるデプロイ

            ![](img/deployer_deploy_06.JPG)

            --

            <!-- .slide: data-transition="none" -->

            ## Deployerによるデプロイ

            ![](img/deployer_deploy_07.JPG)

            --

            ## かつてのデプロイ手順

            1. デプロイサーバにsshでログインする

            2. pdshで`svn info`を実行して、切り戻し用のリビジョンを確認する

            3. pdshで`svn up`を実行して、アプリケーションを最新化する

            4. pdshで`composer install`を実行して、サードパーティー製のパッケージを最新化する

            --

            ## かつてのデプロイ手順

            ```
            $ pdsh -g web "svn co https://repository.com/svn/site.com/trunk /var/www/site.com"
            ```

            ```
            $ pdsh -g web "chmod o+w /var/www/site.com/application/logs"
            ```

            ```
            $ pdsh -g web "chmod o+w /var/www/site.com/application/cache"
            ```

            ```
            $ pdsh -g web "svn co https://repository.com/svn/base/trunk /var/www/site.com/base"
            ```

            ```
            $ pdsh -g web "cd /var/www/site.com; composer install"
            ```

            --

            ## デプロイツールの恩恵

            ```
            $ dep deploy
            ```

            --

            ## タスクの定義

            ```php
task('deploy:update_code', function () {
    $basePath = config()->getPath();
    $repository = get('repository', false);
    $baseRepository = get('base_repository', false);

    if (false === $repository) {
        throw new \RuntimeException('You have to specify repository.');
    }

    $release = date('Ymd') . substr((string)time(), -5);
    $releasePath = "$basePath/releases/$release";

    env()->setReleasePath($releasePath);
    env()->set('is_new_release', true);

    run("svn co $repository $releasePath");
    run("svn co $baseRepository $releasePath/base");

    run("mkdir $releasePath/logs");
})->desc('Updating code');

            ```

            --

            ## タスクのグループ化

            ```php
task('deploy', [
    'deploy:start',
    'deploy:prepare',
    'deploy:update_code',
    'deploy:shared',
    'deploy:writeable_dirs',
    'deploy:symlink',
    'cleanup',
    'deploy:end',
])->desc('Deploy your project');
            ```

            --

            ## デプロイツールの恩恵

            * 作業ミスが格段に減る

            * デプロイ時間を短縮できる

            * デプロイに対する心理的障壁が下がる

            * コード化されることで作業が明確になる

            --

            ![](img/02.jpg)

            ## 今のところはね <!-- {_class="fragment" data-fragment-index="1"} -->

            ---

            ## まとめ

            * デプロイツールを使うと便利

            * 慣れ親しんだ言語

            * デプロイ手順をデフォルトに寄せよう

            ---

            ## 完

            ありがとうございました

          </script>
        </section>

      </div>
    </div>

    <script src="../../reveal.js/lib/js/head.min.js"></script>
    <script src="../../reveal.js/js/reveal.js"></script>
    <script>
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: '../../reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: '../../reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '../../reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '../../reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: '../../reveal.js/plugin/notes/notes.js' }
        ]
      });
    </script>
  </body>
</html>
